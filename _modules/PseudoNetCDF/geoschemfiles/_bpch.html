

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PseudoNetCDF.geoschemfiles._bpch &mdash; PseudoNetCDF 3.4.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=149be4c9"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PseudoNetCDF
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">PseudoNetCDF Userâ€™s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quick.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Example Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readers.html">Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installing.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core.html">Core Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/PseudoNetCDF.html">PseudoNetCDF package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../issues.html">Get in touch</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PseudoNetCDF</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">PseudoNetCDF.geoschemfiles._bpch</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for PseudoNetCDF.geoschemfiles._bpch</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bpch1&#39;</span><span class="p">,</span> <span class="s1">&#39;ncf2bpch&#39;</span><span class="p">,</span> <span class="s1">&#39;bpch_base&#39;</span><span class="p">]</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># part of the default Python distribution</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">warnings</span><span class="w"> </span><span class="kn">import</span> <span class="n">warn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">unittest</span>

<span class="c1"># numpy is a very common installed library</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">fromfile</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">arange</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">concatenate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">append</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sin</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">PseudoNetCDF.sci_var</span><span class="w"> </span><span class="kn">import</span> <span class="n">PseudoNetCDFVariable</span><span class="p">,</span> <span class="n">PseudoNetCDFFile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PseudoNetCDF._getwriter</span><span class="w"> </span><span class="kn">import</span> <span class="n">registerwriter</span>


<span class="k">class</span><span class="w"> </span><span class="nc">OrderedDefaultDict</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;first argument must be callable or None&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OrderedDefaultDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">default</span>


<span class="c1"># These variables define the binary format of the header blocks</span>
<span class="c1"># and are only for internal</span>
<span class="n">_general_header_type</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;&gt;i4, S40, &gt;i4, &gt;i4, S80, &gt;i4&#39;</span><span class="p">)</span>
<span class="n">_datablock_header_type</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;&gt;i4, S20, 2&gt;f4, &gt;i4, &gt;i4, &gt;i4, &gt;i4, S40, &#39;</span> <span class="o">+</span>
                               <span class="s1">&#39;&gt;i4, S40, &gt;f8, &gt;f8, S40, 3&gt;i4, 3&gt;i4, &gt;i4, &gt;i4&#39;</span><span class="p">)</span>
<span class="n">_first_header_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">_general_header_type</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">+</span>
                      <span class="n">_datablock_header_type</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">defaultdictfromkey</span><span class="p">(</span><span class="n">OrderedDefaultDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    defaultdictfromkey dynamically produces dictionary items</span>
<span class="sd">    for keys, using the default_factor function called</span>
<span class="sd">    with the key as an argument</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __missing__(key) # Called by __getitem__ for missing key; pseudo-code:</span>
<span class="sd">        if self.default_factory is None: raise KeyError((key,))</span>
<span class="sd">        self[key] = value = self.default_factory()</span>
<span class="sd">        return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">defaultdictfromthesekeys</span><span class="p">(</span><span class="n">OrderedDefaultDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    defaultdictfromthesekeys dynamically produces dictionary items</span>
<span class="sd">    for known keys, using the default_factor function called</span>
<span class="sd">    with the key as an argument</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        keys - iterable of keys that default_factory can produce</span>
<span class="sd">        default_factory - function that takes a key as an argument</span>
<span class="sd">                          to create a dictionary item</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="n">OrderedDefaultDict</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_factory</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Just like dictionary, but iterates through pre-defined keys</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">i</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Just like dictionary, but iterates through pre-defined key values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Just like dictionary, but iterates through pre-defined keys and their</span>
<span class="sd">        calculated values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Just like dictionary, but iterates through pre-defined keys</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add value with key and add to pre-defined keys</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">OrderedDefaultDict</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete value with key and remove pre-defined key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">:</span>
            <span class="n">ki</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">OrderedDefaultDict</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pop value with key and remove pre-defined key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">OrderedDefaultDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">:</span>
            <span class="n">ki</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __missing__(key) # Called by __getitem__ for missing key; pseudo-code:</span>
<span class="sd">        if self.default_factory is None: raise KeyError((key,))</span>
<span class="sd">        self[key] = value = self.default_factory()</span>
<span class="sd">        return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_factory</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">defaultpseudonetcdfvariable</span><span class="p">(</span><span class="n">defaultdictfromthesekeys</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overwrites __repr__ function to show variables</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">%s</span><span class="s2">&#39;: PseudoNetCDFVariable(...)&quot;</span> <span class="o">%</span> <span class="n">k</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_diag_group</span><span class="p">(</span><span class="n">PseudoNetCDFFile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object acts as a PseudoNetCDF file that gets data from the parent</span>
<span class="sd">    object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">groupvariables</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        parent - a PseudoNetCDFFile</span>
<span class="sd">        groupname - a string describing the group</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%%</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="n">groupname</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">getvar</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">parent</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">template</span> <span class="o">%</span> <span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">parent</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="k">if</span> <span class="s1">&#39;BXHGHT-$_BXHEIGHT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupvariables</span><span class="p">:</span>
            <span class="n">mymetakeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">metakeys</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;VOL&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mymetakeys</span> <span class="o">=</span> <span class="n">metakeys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">defaultpseudonetcdfvariable</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">groupvariables</span><span class="p">)</span> <span class="o">+</span> <span class="n">mymetakeys</span><span class="p">,</span> <span class="n">getvar</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;groups&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

<span class="c1"># This class is designed to operate like a dictionary, but</span>
<span class="c1"># dynamically create variables to return to the user</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_tracer_lookup</span><span class="p">(</span><span class="n">defaultpseudonetcdfvariable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    _tracer_lookup: finds geos_chem tracer indices from names and returns</span>
<span class="sd">                    netcdf like variable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">datamap</span><span class="p">,</span> <span class="n">tracerinfo</span><span class="p">,</span> <span class="n">diaginfo</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span>
                 <span class="n">noscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nogroup</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        parent: NetCDF-like object to serve dimensions</span>
<span class="sd">        datamap: array of pre-dimensioned and datatyped values</span>
<span class="sd">                 dim(tstep, i, j, k)</span>
<span class="sd">        tracerinfo: dictionary of tracer data keyed by ordinal</span>
<span class="sd">        keys: list of keys to serve</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noscale</span> <span class="o">=</span> <span class="n">noscale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nogroup</span> <span class="o">=</span> <span class="n">nogroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracer_data</span> <span class="o">=</span> <span class="n">tracerinfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_diag_data</span> <span class="o">=</span> <span class="n">diaginfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_memmap</span> <span class="o">=</span> <span class="n">datamap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_special_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metakeys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="n">keys</span> <span class="o">+</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_special_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;BXHGHT-$_BXHEIGHT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">ki</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;VOL&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_example_key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">._vertcoord</span><span class="w"> </span><span class="kn">import</span> <span class="n">geos_etai_pressure</span><span class="p">,</span> <span class="n">geos_etam_pressure</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">._vertcoord</span><span class="w"> </span><span class="kn">import</span> <span class="n">geos_hyam</span><span class="p">,</span> <span class="n">geos_hybm</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude_bounds&#39;</span><span class="p">):</span>
            <span class="n">yres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">modelres</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">halfpolar</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">[[</span><span class="o">-</span><span class="mf">90.</span><span class="p">],</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">90.</span> <span class="o">+</span> <span class="n">yres</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="n">yres</span><span class="p">),</span> <span class="p">[</span><span class="mf">90.</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span> <span class="o">+</span> <span class="n">yres</span><span class="p">,</span> <span class="n">yres</span><span class="p">)</span>

            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
                        <span class="n">units</span><span class="o">=</span><span class="s2">&quot;degrees_north&quot;</span><span class="p">,</span> <span class="n">base_units</span><span class="o">=</span><span class="s2">&quot;degrees_north&quot;</span><span class="p">,</span>
                        <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;latitude&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
                <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;latitude_bounds&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;nv&#39;</span><span class="p">,)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">example</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_example_key</span><span class="p">]</span>
            <span class="n">sj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="s1">&#39;STARTJ&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">sj</span><span class="p">:</span><span class="n">sj</span> <span class="o">+</span> <span class="n">example</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude_bounds&#39;</span><span class="p">):</span>
            <span class="n">xres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">modelres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span> <span class="o">+</span> <span class="n">xres</span><span class="p">,</span> <span class="n">xres</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="p">(</span><span class="mi">180</span> <span class="o">+</span> <span class="n">xres</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">center180</span><span class="p">)</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                        <span class="n">units</span><span class="o">=</span><span class="s2">&quot;degrees_east&quot;</span><span class="p">,</span> <span class="n">base_units</span><span class="o">=</span><span class="s2">&quot;degrees_east&quot;</span><span class="p">,</span>
                        <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;longitude&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
                <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;longitude_bounds&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;nv&#39;</span><span class="p">,)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">example</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_example_key</span><span class="p">]</span>
            <span class="n">si</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="s1">&#39;STARTI&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">si</span><span class="p">:</span><span class="n">si</span> <span class="o">+</span> <span class="n">example</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;AREA&#39;</span><span class="p">:</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span>
            <span class="n">xres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">modelres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nlon</span> <span class="o">=</span> <span class="mf">360.</span> <span class="o">/</span> <span class="n">xres</span>
            <span class="n">latb</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;latitude_bounds&#39;</span><span class="p">]</span>
            <span class="n">Re</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">semi_major_axis</span>
            <span class="n">latb</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">latb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">latb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">latr</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span> <span class="o">*</span> <span class="n">latb</span>
            <span class="n">data</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">Re</span> <span class="o">*</span> <span class="n">Re</span> <span class="o">/</span> \
                <span class="p">(</span><span class="n">nlon</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">latr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">latr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;m**2&#39;</span><span class="p">,</span> <span class="n">base_units</span><span class="o">=</span><span class="s1">&#39;m**2&#39;</span><span class="p">,</span> <span class="n">grid_mapping</span><span class="o">=</span><span class="s2">&quot;crs&quot;</span><span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;VOL&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bxhght</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BXHGHT-$_BXHEIGHT&#39;</span><span class="p">]</span>
                <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;AREA&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="s1">&#39;Volume is only available if BXHGHT-$_BXHEIGHT was output&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">area</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">bxhght</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;m**3&#39;</span><span class="p">,</span> <span class="n">base_units</span><span class="o">=</span><span class="s1">&#39;m**3&#39;</span><span class="p">,</span> <span class="n">grid_mapping</span><span class="o">=</span><span class="s2">&quot;crs&quot;</span><span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="s1">&#39;layer&#39;</span> <span class="ow">in</span> <span class="n">dk_</span> <span class="k">for</span> <span class="n">dk_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">dimensions</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;layer</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;crs&#39;</span><span class="p">:</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">grid_mapping_name</span><span class="o">=</span><span class="s2">&quot;latitude_longitude&quot;</span><span class="p">,</span>
                               <span class="n">semi_major_axis</span><span class="o">=</span><span class="mf">6375000.</span><span class="p">,</span>
                               <span class="n">semi_minor_axis</span><span class="o">=</span><span class="mf">6375000.</span><span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;time_bounds&#39;</span><span class="p">):</span>
            <span class="n">tmp_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_example_key</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;tau0&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;tnv&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)</span>

            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;hours since 1985-01-01 00:00:00 UTC&#39;</span><span class="p">,</span>
                        <span class="n">base_units</span><span class="o">=</span><span class="s1">&#39;hours since 1985-01-01 00:00:00 UTC&#39;</span><span class="p">,</span>
                        <span class="n">standard_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">long_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">var_desc</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;time_bounds&#39;</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;hyai&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">Ap</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;layer_bounds&#39;</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;hPa&quot;</span><span class="p">,</span>
                        <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;hybrid A coefficient at layer interfaces&quot;</span><span class="p">,</span>
                        <span class="n">note</span><span class="o">=</span><span class="s2">&quot;unit consistent with GEOS-Chem pressure outputs&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;hyam&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">geos_hyam</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">vertgrid</span><span class="p">]</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;hPa&quot;</span><span class="p">,</span>
                        <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;hybrid B coefficient at layer midpoints&quot;</span><span class="p">,</span>
                        <span class="n">note</span><span class="o">=</span><span class="s2">&quot;unit consistent with GEOS-Chem pressure outputs&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;hybi&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">Bp</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;layer_bounds&#39;</span><span class="p">,)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
                        <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;hybrid B coefficient at layer interfaces&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;hybm&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">geos_hybm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">vertgrid</span><span class="p">]</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">units</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;hybrid B coefficient at layer midpoints&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;layer&#39;</span><span class="p">:</span>
            <span class="n">nlays</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">])</span>
            <span class="n">nedges</span> <span class="o">=</span> <span class="n">nlays</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nedges</span><span class="p">),</span> <span class="s1">&#39;_edges&#39;</span><span class="p">,</span> <span class="s1">&#39;_bounds&#39;</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nedges</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nedges</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">key</span><span class="p">])]</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="n">base_units</span><span class="o">=</span><span class="s1">&#39;model layer&#39;</span><span class="p">,</span>
                        <span class="n">standard_name</span><span class="o">=</span><span class="s1">&#39;model layer&#39;</span><span class="p">,</span> <span class="n">long_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                        <span class="n">var_desc</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;hybrid_sigma_pressure&quot;</span><span class="p">,</span>
                        <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;hybrid level at layer midpoints&quot;</span><span class="p">,</span>
                        <span class="n">units</span><span class="o">=</span><span class="s2">&quot;level&quot;</span><span class="p">,</span>
                        <span class="n">positive</span><span class="o">=</span><span class="s2">&quot;up&quot;</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;etai_pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;etam_pressure&#39;</span><span class="p">):</span>
            <span class="n">nlays</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">])</span>
            <span class="n">nedges</span> <span class="o">=</span> <span class="n">nlays</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;etai&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">geos_etai_pressure</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">vertgrid</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">geos_etam_pressure</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">vertgrid</span><span class="p">]</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">nedges</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;etai&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;layer_bounds&#39;</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">,)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;hPa&#39;</span><span class="p">,</span> <span class="n">base_units</span><span class="o">=</span><span class="s1">&#39;hPa&#39;</span><span class="p">,</span>
                        <span class="n">standard_name</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;atmosphere_hybrid_sigma_pressure_&#39;</span> <span class="o">+</span>
                                       <span class="s1">&#39;coordinate&#39;</span><span class="p">),</span>
                        <span class="n">long_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">var_desc</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;tau0&#39;</span><span class="p">:</span>
            <span class="n">tmp_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_example_key</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memmap</span><span class="p">[</span><span class="n">tmp_key</span><span class="p">][</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;f10&#39;</span><span class="p">]</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;hours since 1985-01-01 00:00:00 UTC&#39;</span><span class="p">,</span>
                        <span class="n">base_units</span><span class="o">=</span><span class="s1">&#39;hours since 1985-01-01 00:00:00 UTC&#39;</span><span class="p">,</span>
                        <span class="n">standard_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">long_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">var_desc</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;tau1&#39;</span><span class="p">:</span>
            <span class="n">tmp_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_example_key</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memmap</span><span class="p">[</span><span class="n">tmp_key</span><span class="p">][</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;f11&#39;</span><span class="p">]</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;hours since 1985-01-01 00:00:00 UTC&#39;</span><span class="p">,</span>
                        <span class="n">base_units</span><span class="o">=</span><span class="s1">&#39;hours since 1985-01-01 00:00:00 UTC&#39;</span><span class="p">,</span>
                        <span class="n">standard_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">long_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">var_desc</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memmap</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sl</span><span class="p">,</span> <span class="n">sj</span><span class="p">,</span> <span class="n">si</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;f14&#39;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;f7&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ASCII&#39;</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diag_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tracerid</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;f8&#39;</span><span class="p">]</span>
            <span class="nb">ord</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;f8&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="n">base_units</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;f9&#39;</span><span class="p">]</span>
            <span class="n">reserved</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;f12&#39;</span><span class="p">]</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracer_data</span><span class="p">[</span><span class="nb">ord</span><span class="p">][</span><span class="s1">&#39;SCALE&#39;</span><span class="p">]</span>
            <span class="n">molwt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracer_data</span><span class="p">[</span><span class="nb">ord</span><span class="p">][</span><span class="s1">&#39;MOLWT&#39;</span><span class="p">]</span>
            <span class="n">carbon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracer_data</span><span class="p">[</span><span class="nb">ord</span><span class="p">][</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracer_data</span><span class="p">[</span><span class="nb">ord</span><span class="p">][</span><span class="s1">&#39;UNIT&#39;</span><span class="p">]</span>
            <span class="n">tmp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_memmap</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="s1">&#39;layer&#39;</span> <span class="ow">in</span> <span class="n">dk_</span> <span class="k">for</span> <span class="n">dk_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">dimensions</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;layer</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="n">tmp_data</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">)</span>
            <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">kgpermole</span><span class="o">=</span><span class="n">molwt</span><span class="p">,</span> <span class="n">carbon</span><span class="o">=</span><span class="n">carbon</span><span class="p">,</span>
                        <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">base_units</span><span class="o">=</span><span class="n">base_units</span><span class="p">,</span> <span class="n">standard_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                        <span class="n">long_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">var_desc</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                        <span class="n">coordinates</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dims</span><span class="p">),</span> <span class="n">grid_mapping</span><span class="o">=</span><span class="s2">&quot;crs&quot;</span><span class="p">,</span>
                        <span class="n">reserved</span><span class="o">=</span><span class="n">reserved</span><span class="p">,</span> <span class="n">tracerid</span><span class="o">=</span><span class="n">tracerid</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="p">((</span><span class="n">tmp_data</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tmp_data</span><span class="p">[</span><span class="s1">&#39;f2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not parse with bpch; try bpch2&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noscale</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">tmp_data</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">tmp_data</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">sl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sj</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">si</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]):</span>
                <span class="n">nl</span><span class="p">,</span> <span class="n">nj</span><span class="p">,</span> <span class="n">ni</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;f13&#39;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;STARTI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span>
                <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;STARTJ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span>
                <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;STARTK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span>
        <span class="k">return</span> <span class="n">PseudoNetCDFVariable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span>
                                    <span class="n">values</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>


<span class="n">coordkeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">,</span>
             <span class="s1">&#39;time_bounds&#39;</span><span class="p">,</span> <span class="s1">&#39;layer_bounds&#39;</span><span class="p">,</span>
             <span class="s1">&#39;latitude_bounds&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude_bounds&#39;</span><span class="p">,</span> <span class="s1">&#39;crs&#39;</span><span class="p">]</span>
<span class="n">metakeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;VOL&#39;</span><span class="p">,</span> <span class="s1">&#39;AREA&#39;</span><span class="p">,</span> <span class="s1">&#39;tau0&#39;</span><span class="p">,</span> <span class="s1">&#39;tau1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;etam_pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;etai_pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;hyam&#39;</span><span class="p">,</span> <span class="s1">&#39;hybm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;hyai&#39;</span><span class="p">,</span> <span class="s1">&#39;hybi&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">coordkeys</span>


<span class="k">class</span><span class="w"> </span><span class="nc">bpch_base</span><span class="p">(</span><span class="n">PseudoNetCDFFile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Binary Punch File reader</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">getTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..coordutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">_parse_ref_date</span>
        <span class="k">if</span> <span class="n">bounds</span><span class="p">:</span>
            <span class="n">timeb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time_bounds&#39;</span><span class="p">]</span>
            <span class="n">timeunit</span> <span class="o">=</span> <span class="n">timeb</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timeb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">timeb</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
            <span class="n">timeunit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="n">timeunit</span><span class="p">:</span>
            <span class="n">unit</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="n">timeunit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; since &#39;</span><span class="p">)</span>
            <span class="n">sdate</span> <span class="o">=</span> <span class="n">_parse_ref_date</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">sdate</span> <span class="o">+</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">timedelta</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">unit</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">time</span><span class="p">[:]])</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">time</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varkey</span><span class="p">,</span> <span class="n">plottype</span><span class="o">=</span><span class="s1">&#39;longitude-latitude&#39;</span><span class="p">,</span> <span class="n">ax_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">plot_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">map_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dimreduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
             <span class="n">laykey</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        self : the bpch file</span>
<span class="sd">        varkey : the variable to plot</span>
<span class="sd">        plottype : longitude-latitude, latitude-pressure, longitude-pressure,</span>
<span class="sd">                   vertical-profile, time-longitude, time-latitude,</span>
<span class="sd">                   time-pressure, default, longitude-latitude</span>
<span class="sd">        ax_kw : keywords for the axes to be created</span>
<span class="sd">        plot_kw : keywords for the plot (plot, scatter, or pcolormesh) to be</span>
<span class="sd">                  created</span>
<span class="sd">        cbar_kw : dictionary or bool or None</span>
<span class="sd">            keywords for the colorbar; if True or None, use defaults.</span>
<span class="sd">            If False, do not create a colorbar</span>
<span class="sd">        map_kw : dictionary or bool or None</span>
<span class="sd">            keywords for the getMap routine, which is only used with</span>
<span class="sd">            map capable dimensions (ie, plottype=&#39;longitude-latitude&#39;)</span>
<span class="sd">            If True or None, use default configuration dict(countries=True,</span>
<span class="sd">            coastlines=True, states=False, counties=False). If False,</span>
<span class="sd">            do not draw a map.</span>
<span class="sd">        dimreduction : dimensions not being used in the plot are removed</span>
<span class="sd">                       using applyAlongDimensions(dimkey=dimreduction) where</span>
<span class="sd">                       each dimenions</span>
<span class="sd">        laykey : name of the layer dimension (e.g., layer47)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..coordutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">getbounds</span>

        <span class="k">if</span> <span class="n">ax_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax_kw</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">plot_kw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kw</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">cbar_kw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cbar_kw</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cbar_kw</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">map_kw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">map_kw</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">map_kw</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">apply2dim</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span>
        <span class="n">varunit</span> <span class="o">=</span> <span class="n">varunit</span> <span class="o">=</span> <span class="n">varkey</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="n">dimlens</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">dk</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">dk</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">dk</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">])</span>
        <span class="n">dimpos</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">dk</span><span class="p">,</span> <span class="n">di</span><span class="p">)</span> <span class="k">for</span> <span class="n">di</span><span class="p">,</span> <span class="n">dk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">laykey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dimlens</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">):</span>
                    <span class="n">laykey</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="k">break</span>
        <span class="n">xkey</span><span class="p">,</span> <span class="n">ykey</span> <span class="o">=</span> <span class="n">plottype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dimkey</span> <span class="ow">in</span> <span class="s1">&#39;longitude latitude time&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">dimkey</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dimkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">xkey</span><span class="p">,</span> <span class="n">ykey</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dimlens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dimkey</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">apply2dim</span><span class="p">[</span><span class="n">dimkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dimreduction</span>

        <span class="k">if</span> <span class="s1">&#39;pressure&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">xkey</span><span class="p">,</span> <span class="n">ykey</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dimlens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">laykey</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">apply2dim</span><span class="p">[</span><span class="n">laykey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dimreduction</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">apply2dim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">myf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyAlongDimensions</span><span class="p">(</span><span class="o">**</span><span class="n">apply2dim</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">myf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span>
            <span class="n">dimlens</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">dk</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">dk</span><span class="p">]))</span>
                            <span class="k">for</span> <span class="n">dk</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">myf</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">ykey</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">,):</span>
            <span class="k">if</span> <span class="n">xkey</span> <span class="o">==</span> <span class="s1">&#39;pressure&#39;</span><span class="p">:</span>
                <span class="n">vaxi</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">laykey</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vaxi</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">xkey</span><span class="p">)</span>
            <span class="n">vsize</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">vaxi</span><span class="p">]</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">var</span><span class="p">[:],</span> <span class="n">vaxi</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vsize</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">var</span><span class="p">[:]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(</span><span class="o">**</span><span class="n">ax_kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ykey</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">,):</span>
            <span class="k">if</span> <span class="n">xkey</span> <span class="o">==</span> <span class="s1">&#39;pressure&#39;</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">myf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;etam_pressure&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">getbounds</span><span class="p">(</span><span class="n">myf</span><span class="p">,</span> <span class="n">xkey</span><span class="p">)</span>

            <span class="n">x0</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">xm</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">varkey</span> <span class="o">+</span> <span class="s1">&#39;(min, max)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xm</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">varkey</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kw</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">xkey</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">varunit</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

        <span class="k">if</span> <span class="n">xkey</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">myf</span><span class="o">.</span><span class="n">getTimes</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">xkey</span> <span class="o">==</span> <span class="s1">&#39;pressure&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">myf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;etai_pressure&#39;</span><span class="p">][:</span><span class="n">dimlens</span><span class="p">[</span><span class="n">laykey</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">getbounds</span><span class="p">(</span><span class="n">myf</span><span class="p">,</span> <span class="n">xkey</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ykey</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">myf</span><span class="o">.</span><span class="n">getTimes</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ykey</span> <span class="o">==</span> <span class="s1">&#39;pressure&#39;</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">myf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;etai_pressure&#39;</span><span class="p">][:</span><span class="n">dimlens</span><span class="p">[</span><span class="n">laykey</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">getbounds</span><span class="p">(</span><span class="n">myf</span><span class="p">,</span> <span class="n">ykey</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dimpos</span><span class="p">[</span><span class="n">xkey</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dimpos</span><span class="p">[</span><span class="n">ykey</span><span class="p">]:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">T</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cbar_kw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">varunit</span><span class="p">,</span> <span class="o">**</span><span class="n">cbar_kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ykey</span> <span class="o">==</span> <span class="s1">&#39;pressure&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">dfmt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">AutoDateFormatter</span><span class="p">(</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">AutoDateLocator</span><span class="p">(</span><span class="n">interval_multiples</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">dfmt</span><span class="o">.</span><span class="n">scaled</span><span class="p">[</span><span class="mi">365</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%F</span><span class="s1">&#39;</span>
        <span class="n">dfmt</span><span class="o">.</span><span class="n">scaled</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%F</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">xkey</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">dfmt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ykey</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">dfmt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s1">&#39;longitude-latitude&#39;</span> <span class="ow">and</span> <span class="n">map_kw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bmap</span> <span class="o">=</span> <span class="n">myf</span><span class="o">.</span><span class="n">getMap</span><span class="p">(</span><span class="o">**</span><span class="n">map_kw</span><span class="p">)</span>
                <span class="n">bmap</span><span class="o">.</span><span class="n">drawcoastlines</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">bmap</span><span class="o">.</span><span class="n">drawcountries</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xkey</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ykey</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">interpSigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vglvls</span><span class="p">,</span> <span class="n">vgtop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interptype</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                    <span class="n">extrapolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">,</span>
                    <span class="n">layerdims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">approach</span><span class="o">=</span><span class="s1">&#39;eta&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        self : the file to interpolate from must have VGLVLS</span>
<span class="sd">        vglvls : the new vglvls (edges)</span>
<span class="sd">        vgtop : Converting to new vgtop (Pascals)</span>
<span class="sd">        interptype : &#39;linear&#39; or &#39;conserve&#39;</span>
<span class="sd">             linear : uses a linear interpolation</span>
<span class="sd">             conserve : uses a mass conserving interpolation</span>
<span class="sd">        extrapolate : allow extrapolation beyond bounds with linear,</span>
<span class="sd">                      default False</span>
<span class="sd">        fill_value : set fill value (e.g, nan) to prevent extrapolation or edge</span>
<span class="sd">                     continuation</span>
<span class="sd">        layerdims : specify layer dimension, None will apply to all dimensions</span>
<span class="sd">                    named layer*</span>
<span class="sd">        approach :</span>
<span class="sd">             eta : use simple eta coordinates to calculate sigma and</span>
<span class="sd">                   interpolate</span>
<span class="sd">             pressure : requires surface pressure</span>
<span class="sd">        verbose : 0-inf show more</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        outf - ioapi_base PseudoNetCDFFile with al variables interpolated</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        When extrapolate is false, the edge values are used for points beyond</span>
<span class="sd">        the inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">etai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;etai_pressure&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="c1"># grab input sigma coordinates</span>
        <span class="n">myvglvls</span> <span class="o">=</span> <span class="p">(</span><span class="n">etai</span> <span class="o">-</span> <span class="n">vgtop</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">etai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">vgtop</span><span class="p">)</span>

        <span class="c1"># Use midpoint for sigmas in inputs and outputs</span>
        <span class="n">zs</span> <span class="o">=</span> <span class="p">(</span><span class="n">myvglvls</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">myvglvls</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">nzs</span> <span class="o">=</span> <span class="p">(</span><span class="n">vglvls</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">vglvls</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span>

        <span class="k">if</span> <span class="n">interptype</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..coordutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">getinterpweights</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">getinterpweights</span><span class="p">(</span>
                <span class="n">zs</span><span class="p">,</span> <span class="n">nzs</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">interptype</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
                <span class="n">extrapolate</span><span class="o">=</span><span class="n">extrapolate</span><span class="p">)</span>
            <span class="c1"># Create a function for interpolation</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">interpsigma</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">newdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="p">[:</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span>
                               <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">newdata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;interptype only implemented for &quot;linear&quot;; got &#39;</span> <span class="o">+</span> <span class="n">interptype</span>
            <span class="p">)</span>

        <span class="c1"># Apply function on LAY</span>
        <span class="k">if</span> <span class="n">layerdims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layerdims</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
                <span class="n">dk</span> <span class="k">for</span> <span class="n">dk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">dk</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="n">dk</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_bounds&#39;</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="n">dk</span> <span class="o">==</span> <span class="s1">&#39;layer1&#39;</span><span class="p">)</span>
            <span class="p">])</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">layerdims</span><span class="p">)</span>
        <span class="n">dimfunc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">layerkey</span><span class="p">,</span> <span class="n">interpsigma</span><span class="p">)</span> <span class="k">for</span> <span class="n">layerkey</span> <span class="ow">in</span> <span class="n">layerdims</span><span class="p">])</span>
        <span class="n">outf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyAlongDimensions</span><span class="p">(</span><span class="o">**</span><span class="n">dimfunc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outf</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">subsetVariables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varkeys</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keepcoords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">exclude</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keepcoords</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="n">varkeys</span> <span class="o">=</span> <span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">coordkeys</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varkeys</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span> <span class="o">+</span>
                       <span class="n">varkeys</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PseudoNetCDFFile</span><span class="o">.</span><span class="n">subsetVariables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varkeys</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">,</span>
                                                <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xy2ll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="s2">&quot;see ll2xy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ll2xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ll2xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        lon and lat are converted to local lon and lat (-180,180) (-90, 90)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lonr</span><span class="p">,</span> <span class="n">latr</span> <span class="o">=</span> <span class="n">PseudoNetCDFFile</span><span class="o">.</span><span class="n">ll2xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">lonr</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">latr</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ij2ll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        i, j to center lon, lat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">lon</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ll2ij</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts lon/lat to 0-based indicies (0,M), (0,N)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lon : scalar or iterable of longitudes in decimal degrees</span>
<span class="sd">        lat : scalar or iterable of latitudes in decimal degrees</span>
<span class="sd">        bounds : ignore, error, warn if i,j are out of domain</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        i, j : indices (0-based) for variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">late</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;latitude_bounds&#39;</span><span class="p">])</span>
        <span class="n">lone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;longitude_bounds&#39;</span><span class="p">])</span>
        <span class="n">inlon</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon</span> <span class="o">&gt;=</span> <span class="n">lone</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon</span> <span class="o">&lt;</span> <span class="n">lone</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">inlat</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat</span> <span class="o">&gt;=</span> <span class="n">late</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat</span> <span class="o">&lt;</span> <span class="n">late</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inlon</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">inlat</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">bounds</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;lat/lon not in domain&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">bounds</span> <span class="o">==</span> <span class="s1">&#39;warn&#39;</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;lat/lon not in domain&#39;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">inlon</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">inlat</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>


<div class="viewcode-block" id="bpch1">
<a class="viewcode-back" href="../../../api/PseudoNetCDF.geoschemfiles.html#PseudoNetCDF.geoschemfiles.bpch1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">bpch1</span><span class="p">(</span><span class="n">bpch_base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NetCDF-like class to interface with GEOS-Chem binary punch files</span>

<span class="sd">    f = bpch(path_to_binary_file)</span>
<span class="sd">    dim = f.dimensions[dkey] # e.g., dkey = &#39;longitude&#39;</span>

<span class="sd">    # There are two ways to get variables.  Directly from</span>
<span class="sd">    # the file using the long name</span>
<span class="sd">    var = f.variables[vkey] # e.g., vkey = &#39;IJ-AVG-$_NOx&#39;</span>

<span class="sd">    # Or through a group using the short name</span>
<span class="sd">    g = f.groups[gkey] # e.g., gkey = &#39;IJ-AVG-$&#39;</span>
<span class="sd">    var = g.variables[vkey] # e.g., vkey = &#39;NOx&#39;</span>

<span class="sd">    # The variable returned is the same either way</span>
<span class="sd">    print(f.dimensions)</span>
<span class="sd">    print(var.unit)</span>
<span class="sd">    print(var.dimensions)</span>
<span class="sd">    print(var.shape)</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="bpch1.isMine">
<a class="viewcode-back" href="../../../api/PseudoNetCDF.geoschemfiles.html#PseudoNetCDF.geoschemfiles.bpch1.isMine">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">isMine</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read binary data for general header and first datablock header</span>
            <span class="n">header_block</span> <span class="o">=</span> <span class="n">fromfile</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">_first_header_size</span><span class="p">)</span>

            <span class="c1"># combine data for convenience</span>
            <span class="n">ght</span> <span class="o">=</span> <span class="n">_general_header_type</span>
            <span class="n">ghts</span> <span class="o">=</span> <span class="n">ght</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="n">dht</span> <span class="o">=</span> <span class="n">_datablock_header_type</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">header_block</span><span class="p">[:</span><span class="n">ghts</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">ght</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                      <span class="nb">tuple</span><span class="p">(</span><span class="n">header_block</span><span class="p">[</span><span class="n">ghts</span><span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dht</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="c1"># Verify that all Fortran unformatted buffers match</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">header</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="bpch1.from_ncf">
<a class="viewcode-back" href="../../../api/PseudoNetCDF.geoschemfiles.html#PseudoNetCDF.geoschemfiles.bpch1.from_ncf">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_ncf</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">infile</span><span class="p">):</span>
        <span class="n">outf</span> <span class="o">=</span> <span class="n">bpch_base</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">infile</span><span class="o">.</span><span class="n">ncattrs</span><span class="p">():</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">outf</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">pv</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dk</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">infile</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">copyDimension</span><span class="p">(</span><span class="n">dv</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">dk</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">infile</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">copyVariable</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">vk</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outf</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_newlike</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PseudoNetCDFFile</span><span class="p">):</span>
            <span class="n">outt</span> <span class="o">=</span> <span class="n">bpch_base</span>
            <span class="n">outf</span> <span class="o">=</span> <span class="n">outt</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">outt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outf</span> <span class="o">=</span> <span class="n">PseudoNetCDFFile</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">outf</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bpch_path</span><span class="p">,</span> <span class="n">tracerinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diaginfo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                 <span class="n">timeslice</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">noscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">vertgrid</span><span class="o">=</span><span class="s1">&#39;GEOS-5-REDUCED&#39;</span><span class="p">,</span> <span class="n">nogroup</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        bpch_path: path to binary punch file</span>
<span class="sd">        tracerinfo: path to ascii file with tracer definitions</span>
<span class="sd">        diaginfo: path to ascii file with diagnostic group definitions</span>
<span class="sd">        mode : {&#39;r+&#39;, &#39;r&#39;, &#39;w+&#39;, &#39;c&#39;}, optional</span>
<span class="sd">         |      The file is opened in this mode:</span>
<span class="sd">         |</span>
<span class="sd">         | +------+-----------------------------------------------------------+</span>
<span class="sd">         | | &#39;r&#39;  | Open existing file for reading only.                      |</span>
<span class="sd">         | +------+-----------------------------------------------------------+</span>
<span class="sd">         | | &#39;r+&#39; | Open existing file for reading and writing.               |</span>
<span class="sd">         | +------+-----------------------------------------------------------+</span>
<span class="sd">         | | &#39;w+&#39; | Create or overwrite existing file for reading and writing.|</span>
<span class="sd">         | +------+-----------------------------------------------------------+</span>
<span class="sd">         | | &#39;c&#39;  | Copy-on-write: assignments affect data in memory, but     |</span>
<span class="sd">         | |      | changes are not saved to disk.  The file on disk is       |</span>
<span class="sd">         | |      | read-only.                                                |</span>
<span class="sd">         | +------+-----------------------------------------------------------+</span>
<span class="sd">         timeslice: If the file is larger than 2GB, timeslice provides a way</span>
<span class="sd">                    to subset results. The subset requested depends on the</span>
<span class="sd">                    data type of timeslice:</span>
<span class="sd">                        - int: return the a part of the file if it was broken</span>
<span class="sd">                               into 2GB chunks (0..N-1)</span>
<span class="sd">                        - slice: return the times that correspond to that slice</span>
<span class="sd">                                 (i.e., range(ntimes)[timeslice])</span>
<span class="sd">                        - list/tuple/set: return specified times where each</span>
<span class="sd">                                          time is in the set (0..N-1)</span>
<span class="sd">         noscale: Do not apply scaling factors</span>
<span class="sd">         vertgrid: vertical coordinate system (options: &#39;GEOS-5-REDUCED&#39;,</span>
<span class="sd">                   &#39;GEOS-5-NATIVE&#39;, &#39;MERRA-REDUCED&#39;, &#39;MERRA-NATIVE&#39;,</span>
<span class="sd">                   &#39;GEOS-4-REDUCED&#39;, &#39;GEOS-4-NATIVE&#39;, default &#39;GEOS-5-REDUCED&#39;)</span>
<span class="sd">         nogroup: False - use all groups, True - use no groups, list of groups</span>
<span class="sd">                  to ignore</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">._vertcoord</span><span class="w"> </span><span class="kn">import</span> <span class="n">geos_hyai</span><span class="p">,</span> <span class="n">geos_hybi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ncattrs</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noscale</span> <span class="o">=</span> <span class="n">noscale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nogroup</span> <span class="o">=</span> <span class="n">nogroup</span>
        <span class="c1"># Read binary data for general header and first datablock header</span>
        <span class="n">header_block</span> <span class="o">=</span> <span class="n">fromfile</span><span class="p">(</span><span class="n">bpch_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span>
                                <span class="n">count</span><span class="o">=</span><span class="n">_first_header_size</span><span class="p">)</span>

        <span class="c1"># combine data for convenience</span>
        <span class="n">ght</span> <span class="o">=</span> <span class="n">_general_header_type</span>
        <span class="n">dht</span> <span class="o">=</span> <span class="n">_datablock_header_type</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">header_block</span><span class="p">[:</span><span class="n">ght</span><span class="o">.</span><span class="n">itemsize</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">ght</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                  <span class="nb">tuple</span><span class="p">(</span><span class="n">header_block</span><span class="p">[</span><span class="n">ght</span><span class="o">.</span><span class="n">itemsize</span><span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dht</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Verify that all Fortran unformatted buffers match</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">header</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;BPCH Files fails header check&quot;</span><span class="p">)</span>

        <span class="c1"># Assign data from header to global attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toptitle</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelres</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">halfpolar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center180</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_tau0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_tau1</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">]</span>
        <span class="n">dummy</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span>
        <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">22</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dk</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="s1">&#39;longitude latitude layer&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">dim</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span> <span class="n">dv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;nv&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;tnv&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">tracerinfo</span> <span class="o">=</span> <span class="n">tracerinfo</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">bpch_path</span><span class="p">),</span> <span class="s1">&#39;tracerinfo.dat&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tracerinfo</span><span class="p">,</span> <span class="s1">&#39;seek&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tracerinfo</span><span class="p">,</span> <span class="s1">&#39;readlines&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tracerinfo</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tracerinfo</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
                <span class="n">tracerinfo</span> <span class="o">=</span> <span class="s1">&#39;tracerinfo.dat&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tracerinfo</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tracerinfo</span><span class="p">):</span>
                    <span class="n">tracerinfo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tracerinfo</span><span class="p">,</span> <span class="s1">&#39;tracerinfo.dat&#39;</span><span class="p">)</span>

            <span class="n">tracerinfo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tracerinfo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracerinfofile</span> <span class="o">=</span> <span class="n">tracerinfo</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tracerinfo</span><span class="p">,</span> <span class="s1">&#39;readlines&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tracerinfo</span><span class="p">,</span> <span class="s1">&#39;seek&#39;</span><span class="p">):</span>
            <span class="n">tracer_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">myl</span> <span class="ow">in</span> <span class="n">tracerinfo</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">myl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">):</span>
                    <span class="n">tkey</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">myl</span><span class="p">[</span><span class="mi">52</span><span class="p">:</span><span class="mi">61</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">tdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tdict</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">myl</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">tdict</span><span class="p">[</span><span class="s1">&#39;FULLNAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">myl</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">39</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">tdict</span><span class="p">[</span><span class="s1">&#39;MOLWT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">myl</span><span class="p">[</span><span class="mi">39</span><span class="p">:</span><span class="mi">49</span><span class="p">])</span>
                    <span class="n">tdict</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">myl</span><span class="p">[</span><span class="mi">49</span><span class="p">:</span><span class="mi">52</span><span class="p">])</span>
                    <span class="n">tdict</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">myl</span><span class="p">[</span><span class="mi">52</span><span class="p">:</span><span class="mi">61</span><span class="p">])</span>
                    <span class="n">tdict</span><span class="p">[</span><span class="s1">&#39;SCALE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">myl</span><span class="p">[</span><span class="mi">61</span><span class="p">:</span><span class="mi">71</span><span class="p">])</span>
                    <span class="n">tdict</span><span class="p">[</span><span class="s1">&#39;UNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">myl</span><span class="p">[</span><span class="mi">72</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">tracer_data</span><span class="p">[</span><span class="n">tkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdict</span>

            <span class="n">tracer_names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">])</span>
                                 <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tracer_data</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Reading file without tracerinfo.dat means that names &#39;</span> <span class="o">+</span>
                 <span class="s1">&#39;and scaling are unknown&#39;</span><span class="p">)</span>
            <span class="n">tracer_data</span> <span class="o">=</span> <span class="n">OrderedDefaultDict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">SCALE</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">MOLWT</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">UNIT</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
                <span class="n">FULLNAME</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="n">NAME</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">))</span>
            <span class="n">tracer_names</span> <span class="o">=</span> <span class="n">defaultdictfromkey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>

        <span class="n">diaginfo</span> <span class="o">=</span> <span class="n">diaginfo</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">bpch_path</span><span class="p">),</span> <span class="s1">&#39;diaginfo.dat&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">diaginfo</span><span class="p">,</span> <span class="s1">&#39;readlines&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">diaginfo</span><span class="p">,</span> <span class="s1">&#39;seek&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">diaginfo</span><span class="p">):</span>
                <span class="n">diaginfo</span> <span class="o">=</span> <span class="s1">&#39;diaginfo.dat&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">diaginfo</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">diaginfo</span><span class="p">):</span>
                    <span class="n">diaginfo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diaginfo</span><span class="p">,</span> <span class="s1">&#39;diaginfo.dat&#39;</span><span class="p">)</span>
            <span class="n">diaginfo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">diaginfo</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_diaginfofile</span> <span class="o">=</span> <span class="n">diaginfo</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">diaginfo</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">diaginfo</span><span class="p">,</span> <span class="s1">&#39;seek&#39;</span><span class="p">):</span>
            <span class="n">diag_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>
                <span class="p">(</span>
                    <span class="n">myl</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">49</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">myl</span><span class="p">[:</span><span class="mi">8</span><span class="p">]),</span> <span class="n">desc</span><span class="o">=</span><span class="n">myl</span><span class="p">[</span><span class="mi">50</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">myl</span> <span class="ow">in</span> <span class="n">diaginfo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">myl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#&#39;</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Reading file without diaginfo.dat loses descriptive &#39;</span> <span class="o">+</span>
                 <span class="s1">&#39;information&#39;</span><span class="p">)</span>
            <span class="n">diag_data</span> <span class="o">=</span> <span class="n">defaultdictfromkey</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">key</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">tracer_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tracer_names</span><span class="p">,</span> <span class="n">defaultdictfromkey</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error parsing </span><span class="si">%s</span><span class="s2"> for Tracer data&quot;</span> <span class="o">%</span> <span class="n">tracerinfo</span><span class="p">)</span>
        <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">bpch_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">_general_header_type</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">data_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">first_header</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span> <span class="o">=</span> <span class="n">OrderedDefaultDict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">first_header</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> \
                <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">file_size</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">memmap</span><span class="p">(</span><span class="n">bpch_path</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                <span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_datablock_header_type</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">group</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">tracer_number</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">diag_data</span><span class="p">,</span> <span class="n">defaultdictfromkey</span><span class="p">):</span>
                <span class="n">goffset</span> <span class="o">=</span> <span class="n">diag_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tracername</span> <span class="o">=</span> <span class="n">tracer_names</span><span class="p">[</span><span class="n">tracer_number</span> <span class="o">+</span> <span class="n">goffset</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># There are some cases like with the adjoint where the</span>
                    <span class="c1"># tracer does not have a tracerinfo.dat line.  In this</span>
                    <span class="c1"># case, the name matches the tracer with that number</span>
                    <span class="c1"># (no offset).  The scaling, however, is not intended</span>
                    <span class="c1"># to be used. The unit for adjoint, for instance, is</span>
                    <span class="c1"># unitless.</span>
                    <span class="k">if</span> <span class="n">tracer_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tracer_names</span><span class="p">:</span>
                        <span class="n">tracername</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tracer_number</span><span class="p">)</span>
                        <span class="n">tracer_data</span><span class="p">[</span><span class="n">tracer_number</span> <span class="o">+</span> <span class="n">goffset</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                            <span class="n">SCALE</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">UNIT</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">MOLWT</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                            <span class="n">FULLNAME</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="n">NAME</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tracername</span> <span class="o">=</span> <span class="n">tracer_names</span><span class="p">[</span><span class="n">tracer_number</span><span class="p">]</span>
                        <span class="n">tracer_data</span><span class="p">[</span><span class="n">tracer_number</span> <span class="o">+</span> <span class="n">goffset</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                            <span class="n">SCALE</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="n">tracer_data</span><span class="p">[</span><span class="n">tracer_number</span><span class="p">][</span><span class="s1">&#39;C&#39;</span><span class="p">],</span>
                            <span class="n">UNIT</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">MOLWT</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in diaginfo.dat; &#39;</span> <span class="o">%</span> <span class="n">group</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39;names and scaling cannot be resolved&#39;</span><span class="p">)</span>
                <span class="n">goffset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">tracername</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tracer_number</span><span class="p">)</span>
                <span class="n">diag_data</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
                <span class="n">tracer_data</span><span class="p">[</span><span class="n">tracer_number</span> <span class="o">+</span>
                            <span class="n">goffset</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">SCALE</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">UNIT</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tracername</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">_datablock_header_type</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">first_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">first_header</span> <span class="o">=</span> <span class="n">header</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="n">first_header</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">first_header</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="ow">or</span>
                <span class="n">offset</span> <span class="o">==</span> <span class="n">file_size</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="n">file_size</span><span class="p">:</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">13</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># start = header[14][::-1]</span>
                    <span class="n">dimstr</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dim</span><span class="p">])</span>
                    <span class="n">data_type</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;&gt;i4, (</span><span class="si">%s</span><span class="s1">)&gt;f4, &gt;i4&#39;</span> <span class="o">%</span> <span class="n">dimstr</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="p">(</span><span class="n">data_type</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">==</span> <span class="n">header</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">data_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nogroup</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tracername</span><span class="p">,))</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nogroup</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">tracername</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nogroup</span><span class="p">:</span>
                        <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tracername</span><span class="p">,))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">tracername</span><span class="p">))</span>

                <span class="k">break</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">13</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># start = header[14][::-1]</span>
            <span class="n">dimstr</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dim</span><span class="p">])</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;&gt;i4, (</span><span class="si">%s</span><span class="s1">)&gt;f4, &gt;i4&#39;</span> <span class="o">%</span> <span class="n">dimstr</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">data_type</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">==</span> <span class="n">header</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">data_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nogroup</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tracername</span><span class="p">,))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nogroup</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">tracername</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nogroup</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tracername</span><span class="p">,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">tracername</span><span class="p">))</span>

        <span class="c1"># Repeating tracer indicates end of timestep</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="n">time_type</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">dtype</span><span class="p">([(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">),</span> <span class="n">_datablock_header_type</span><span class="p">),</span>
                        <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">),</span> <span class="n">d</span><span class="p">)]))</span>
             <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">data_types</span><span class="p">)])</span>
        <span class="n">field_shapes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">time_type</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="n">field_levs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">s_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="n">field_shapes</span><span class="p">])</span>
        <span class="c1"># field_rows = set([s_[1] for s_ in field_shapes])</span>
        <span class="c1"># field_cols = set([s_[2] for s_ in field_shapes])</span>
        <span class="n">field_levs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">field_levs</span><span class="p">)</span>
        <span class="n">field_levs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">field_levs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;layer</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fl</span><span class="p">,</span> <span class="n">fl</span><span class="p">)</span>

        <span class="n">itemcount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">bpch_path</span><span class="p">))</span> <span class="o">-</span>
                         <span class="n">_general_header_type</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span> <span class="o">//</span> <span class="n">time_type</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">itemcount</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot read whole file; assuming partial time block is at &quot;</span> <span class="o">+</span>
                 <span class="s2">&quot;the end; skipping partial time record&quot;</span><span class="p">)</span>
            <span class="n">itemcount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">itemcount</span><span class="p">))</span>

        <span class="c1"># load all data blocks</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datamap</span> <span class="o">=</span> <span class="n">memmap</span><span class="p">(</span><span class="n">bpch_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">time_type</span><span class="p">,</span>
                             <span class="n">offset</span><span class="o">=</span><span class="n">_general_header_type</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                             <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">itemcount</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">timeslice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">datamap</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[</span><span class="n">timeslice</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">OverflowError</span><span class="p">:</span>
            <span class="n">hdrsize</span> <span class="o">=</span> <span class="n">_general_header_type</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">hdrsize</span><span class="p">)</span> <span class="o">//</span> <span class="n">time_type</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="k">if</span> <span class="n">timeslice</span> <span class="o">!=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">filesize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">bpch_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
                <span class="n">datasize</span> <span class="o">=</span> <span class="p">(</span><span class="n">filesize</span> <span class="o">-</span> <span class="n">hdrsize</span><span class="p">)</span>
                <span class="n">all_times</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">datasize</span> <span class="o">/</span> <span class="n">time_type</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timeslice</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">timeslice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">items</span> <span class="o">*</span> <span class="n">timeslice</span><span class="p">,</span>
                                      <span class="n">items</span> <span class="o">*</span> <span class="p">(</span><span class="n">timeslice</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timeslice</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
                    <span class="n">times</span> <span class="o">=</span> <span class="n">timeslice</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">times</span> <span class="o">=</span> <span class="n">all_times</span><span class="p">[</span><span class="n">timeslice</span><span class="p">]</span>

                <span class="n">outpath</span> <span class="o">=</span> <span class="n">bpch_path</span> <span class="o">+</span> <span class="s1">&#39;.tmp.part&#39;</span>
                <span class="n">mint</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">maxt</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">nt</span> <span class="o">=</span> <span class="n">maxt</span> <span class="o">-</span> <span class="n">mint</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">nt</span> <span class="o">&gt;</span> <span class="n">items</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">((</span><span class="s1">&#39;Requested </span><span class="si">%d</span><span class="s1"> items; only returning </span><span class="si">%d</span><span class="s1"> items due &#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;to 2GB limitation&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">items</span><span class="p">))</span>
                    <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[:</span><span class="n">items</span><span class="p">]</span>

                <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">bpch_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdrsize</span><span class="p">)</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_times</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
                        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">time_type</span><span class="o">.</span><span class="n">itemsize</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">infile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">time_type</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">datamap</span> <span class="o">=</span> <span class="n">memmap</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">time_type</span><span class="p">,</span>
                                 <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">hdrsize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datamap</span> <span class="o">=</span> <span class="n">memmap</span><span class="p">(</span><span class="n">bpch_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">time_type</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">items</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="n">_general_header_type</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Returning only the first 2GB of data&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">datamap</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">gn</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;f7&#39;</span><span class="p">]</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="n">datamap</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;f8&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="p">((</span><span class="n">tid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tid</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
            <span class="k">assert</span> <span class="p">((</span><span class="n">gn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">gn</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="n">layerns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">datamap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;f13&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                       <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">datamap</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">])</span>
        <span class="n">maxlayerns</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">layerns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vertgrid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">maxlayerns</span> <span class="o">&gt;</span> <span class="mi">48</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vertgrid</span> <span class="o">=</span> <span class="n">vertgrid</span> <span class="o">=</span> <span class="s1">&#39;GEOS-5-NATIVE&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vertgrid</span> <span class="o">=</span> <span class="n">vertgrid</span> <span class="o">=</span> <span class="s1">&#39;GEOS-5-REDUCED&#39;</span>

            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Vertical grid was diagnosted as </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">vertgrid</span><span class="p">)</span>

        <span class="c1"># Create variables and dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertgrid</span> <span class="o">=</span> <span class="n">vertgrid</span>
        <span class="c1"># Ap [hPa]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ap</span> <span class="o">=</span> <span class="n">geos_hyai</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertgrid</span><span class="p">]</span>

        <span class="c1"># Bp [unitless]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bp</span> <span class="o">=</span> <span class="n">geos_hybi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vertgrid</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">layerns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ap</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;vertgrid selected (</span><span class="si">%s</span><span class="s2">) and output layers are not &quot;</span> <span class="o">+</span>
                 <span class="s2">&quot;consistent; update to GEOS-5-NATIVE (e.g., bpch(..., &quot;</span> <span class="o">+</span>
                 <span class="s2">&quot;vertgrid=&#39;GEOS-5-NATIVE&#39;) -f </span><span class="se">\&quot;</span><span class="s2">bpch,&quot;</span> <span class="o">+</span>
                 <span class="s2">&quot;vertgrid=&#39;GEOS-5-NATIVE&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vertgrid</span><span class="p">)</span>

        <span class="n">layerkeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;layer_bounds&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;layer</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">myl</span> <span class="k">for</span> <span class="n">myl</span> <span class="ow">in</span> <span class="n">layerns</span><span class="p">]</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">layerkeys</span><span class="p">)</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;hyai&#39;</span><span class="p">,</span> <span class="s1">&#39;hyam&#39;</span><span class="p">,</span> <span class="s1">&#39;hybi&#39;</span><span class="p">,</span> <span class="s1">&#39;hybm&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;etai_pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;etam_pressure&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ap</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;layer_bounds&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ap</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">_tracer_lookup</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">datamap</span><span class="o">=</span><span class="n">datamap</span><span class="p">,</span>
                                        <span class="n">tracerinfo</span><span class="o">=</span><span class="n">tracer_data</span><span class="p">,</span>
                                        <span class="n">diaginfo</span><span class="o">=</span><span class="n">diag_data</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
                                        <span class="n">noscale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noscale</span><span class="p">,</span>
                                        <span class="n">nogroup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nogroup</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noscale</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">vk</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">vk</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">1.</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Not scaling variables; good for direct writing&quot;</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">datamap</span>
        <span class="n">tdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;tau0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">tdim</span><span class="o">.</span><span class="n">setunlimited</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">_diag_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">dk</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dmn</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                <span class="n">dmn</span><span class="o">.</span><span class="n">setunlimited</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">isunlimited</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Conventions</span> <span class="o">=</span> <span class="s2">&quot;CF-1.6&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PseudoNetCDFFile</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span></div>



<div class="viewcode-block" id="ncf2bpch">
<a class="viewcode-back" href="../../../api/PseudoNetCDF.geoschemfiles.html#PseudoNetCDF.geoschemfiles.ncf2bpch">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ncf2bpch</span><span class="p">(</span><span class="n">ncffile</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">_general_header_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SPAD1&#39;</span><span class="p">,</span> <span class="s1">&#39;ftype&#39;</span><span class="p">,</span> <span class="s1">&#39;EPAD1&#39;</span><span class="p">,</span> <span class="s1">&#39;SPAD2&#39;</span><span class="p">,</span> <span class="s1">&#39;toptitle&#39;</span><span class="p">,</span> <span class="s1">&#39;EPAD2&#39;</span><span class="p">],</span>
        <span class="n">formats</span><span class="o">=</span><span class="s1">&#39;&gt;i4, S40, &gt;i4, &gt;i4, S80, &gt;i4&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
    <span class="n">_datablock_header_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SPAD1&#39;</span><span class="p">,</span> <span class="s1">&#39;modelname&#39;</span><span class="p">,</span> <span class="s1">&#39;modelres&#39;</span><span class="p">,</span> <span class="s1">&#39;halfpolar&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;center180&#39;</span><span class="p">,</span> <span class="s1">&#39;EPAD1&#39;</span><span class="p">,</span> <span class="s1">&#39;SPAD2&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;tracerid&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;tau0&#39;</span><span class="p">,</span> <span class="s1">&#39;tau1&#39;</span><span class="p">,</span> <span class="s1">&#39;reserved&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;skip&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;EPAD2&#39;</span><span class="p">],</span>
             <span class="n">formats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&gt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;2&gt;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i4&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;S40&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;S40&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;S40&#39;</span><span class="p">,</span> <span class="s1">&#39;6&gt;i4&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;&gt;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i4&#39;</span><span class="p">]))</span>
    <span class="n">varkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ncffile</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
               <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;tracerid&#39;</span><span class="p">)</span> <span class="ow">and</span>
                   <span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metakeys</span> <span class="ow">and</span>
                   <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">)))]</span>

    <span class="n">var_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">varkey</span> <span class="ow">in</span> <span class="n">varkeys</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">ncffile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&gt;f&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">var_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="s1">&#39;SPAD1&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;EPAD1&#39;</span><span class="p">],</span>
                 <span class="n">formats</span><span class="o">=</span><span class="p">[</span><span class="n">_datablock_header_type</span><span class="p">,</span> <span class="s1">&#39;&gt;i&#39;</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="s1">&#39;&gt;i&#39;</span><span class="p">])))</span>
    <span class="n">general_header</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_general_header_type</span><span class="p">)</span>
    <span class="n">general_header</span><span class="p">[</span><span class="s1">&#39;SPAD1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">general_header</span><span class="p">[</span><span class="s1">&#39;EPAD1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">general_header</span><span class="p">[</span><span class="s1">&#39;SPAD2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">general_header</span><span class="p">[</span><span class="s1">&#39;EPAD2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="n">general_header</span><span class="p">[</span><span class="s1">&#39;ftype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncffile</span><span class="o">.</span><span class="n">ftype</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">general_header</span><span class="p">[</span><span class="s1">&#39;toptitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncffile</span><span class="o">.</span><span class="n">toptitle</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">general_header</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="n">time_data</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">varkeys</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="n">var_types</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">varkey</span> <span class="ow">in</span> <span class="n">varkeys</span><span class="p">:</span>
        <span class="n">tdv</span> <span class="o">=</span> <span class="n">time_data</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">attrk</span> <span class="ow">in</span> <span class="n">_datablock_header_type</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]:</span>
            <span class="n">tdv</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="n">attrk</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ncffile</span><span class="p">,</span> <span class="n">attrk</span><span class="p">)</span>

        <span class="n">tdv</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;SPAD1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdv</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;EPAD1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">36</span>
        <span class="n">tdv</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;SPAD2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdv</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;EPAD2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">168</span>

    <span class="n">ttz</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ncffile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;tau0&#39;</span><span class="p">],</span> <span class="n">ncffile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="p">(</span><span class="n">tau0</span><span class="p">,</span> <span class="n">tau1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ttz</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">varkey</span> <span class="ow">in</span> <span class="n">varkeys</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">ncffile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;tracerid&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">tau0</span><span class="p">,</span> <span class="n">tau1</span><span class="p">,</span> <span class="n">varkey</span><span class="p">)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span>
            <span class="n">tdv</span> <span class="o">=</span> <span class="n">time_data</span><span class="p">[</span><span class="n">varkey</span><span class="p">]</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">tdv</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">tdv</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;tau0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau0</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau1</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;reserved&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;reserved&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;tracerid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">tracerid</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">base_units</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                             <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">k_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                              <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="s1">&#39;STARTI STARTJ STARTK&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>

            <span class="n">tdv</span><span class="p">[</span><span class="s1">&#39;SPAD1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdv</span><span class="p">[</span><span class="s1">&#39;EPAD1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdv</span><span class="p">[</span><span class="s1">&#39;SPAD1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span>
            <span class="k">if</span> <span class="n">ncffile</span><span class="o">.</span><span class="n">noscale</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">vals</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">/</span> <span class="n">var</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">time_data</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>

    <span class="n">outfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
    <span class="n">tracerpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;tracerinfo.dat&#39;</span><span class="p">)</span>
    <span class="n">diagpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;diaginfo.dat&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ncffile</span><span class="p">,</span> <span class="s1">&#39;_tracerinfofile&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tracerpath</span><span class="p">):</span>
            <span class="n">ncffile</span><span class="o">.</span><span class="n">_tracerinfofile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ncffile</span><span class="o">.</span><span class="n">_tracerinfofile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">outtrace</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tracerpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">outtrace</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ncffile</span><span class="o">.</span><span class="n">_tracerinfofile</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">outtrace</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ncffile</span><span class="p">,</span> <span class="s1">&#39;_diaginfofile&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">diagpath</span><span class="p">):</span>
            <span class="n">ncffile</span><span class="o">.</span><span class="n">_diaginfofile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">outdiag</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">diagpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">outdiag</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ncffile</span><span class="o">.</span><span class="n">_diaginfofile</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">outdiag</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">outfile</span></div>



<span class="n">registerwriter</span><span class="p">(</span><span class="s1">&#39;bpch&#39;</span><span class="p">,</span> <span class="n">ncf2bpch</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestMemmaps</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PseudoNetCDF.testcase</span><span class="w"> </span><span class="kn">import</span> <span class="n">geoschemfiles_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpchpath</span> <span class="o">=</span> <span class="n">geoschemfiles_paths</span><span class="p">[</span><span class="s1">&#39;bpch&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">testBPCH12NCF</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bpchfile</span> <span class="o">=</span> <span class="n">bpch1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bpchpath</span><span class="p">)</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpchpath</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>
        <span class="n">ncfile</span> <span class="o">=</span> <span class="n">bpchfile</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ncv</span> <span class="ow">in</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">bpv</span> <span class="o">=</span> <span class="n">bpchfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">ncv</span><span class="p">[</span><span class="o">...</span><span class="p">],</span> <span class="n">bpv</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">testNCF2BPCH1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;Not scaling variables; good for direct writing&#39;</span>
            <span class="p">)</span>
            <span class="n">bpchfile</span> <span class="o">=</span> <span class="n">bpch1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bpchpath</span><span class="p">,</span> <span class="n">noscale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpchpath</span> <span class="o">+</span> <span class="s1">&#39;.check&#39;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PseudoNetCDF.pncgen</span><span class="w"> </span><span class="kn">import</span> <span class="n">pncgen</span>
        <span class="n">pncgen</span><span class="p">(</span><span class="n">bpchfile</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">inmode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
               <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;bpch&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bpchpath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">orig</span> <span class="o">==</span> <span class="n">new</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PseudoNetCDF.sci_var</span><span class="w"> </span><span class="kn">import</span> <span class="n">reduce_dim</span><span class="p">,</span> <span class="n">slice_dim</span>
        <span class="n">ALD2</span> <span class="o">=</span> <span class="n">bpchfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;IJ-AVG-$_ALD2&#39;</span><span class="p">]</span>
        <span class="n">ALD2_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mf">1.60520077e-02</span><span class="p">,</span> <span class="mf">1.82803553e-02</span><span class="p">,</span> <span class="mf">2.00258084e-02</span><span class="p">,</span> <span class="mf">2.01461259e-02</span><span class="p">,</span>
             <span class="mf">1.84865110e-02</span><span class="p">,</span> <span class="mf">2.49667447e-02</span><span class="p">,</span> <span class="mf">2.73083989e-02</span><span class="p">,</span> <span class="mf">2.87465211e-02</span><span class="p">,</span>
             <span class="mf">2.89694592e-02</span><span class="p">,</span> <span class="mf">2.87686456e-02</span><span class="p">,</span> <span class="mf">2.87277419e-02</span><span class="p">,</span> <span class="mf">3.08121163e-02</span><span class="p">,</span>
             <span class="mf">3.22086290e-02</span><span class="p">,</span> <span class="mf">3.35262120e-02</span><span class="p">,</span> <span class="mf">3.41329686e-02</span><span class="p">,</span> <span class="mf">3.05218045e-02</span><span class="p">,</span>
             <span class="mf">3.30278911e-02</span><span class="p">,</span> <span class="mf">3.58164124e-02</span><span class="p">,</span> <span class="mf">3.93186994e-02</span><span class="p">,</span> <span class="mf">4.15412188e-02</span><span class="p">,</span>
             <span class="mf">1.60520077e-02</span><span class="p">,</span> <span class="mf">1.82803553e-02</span><span class="p">,</span> <span class="mf">2.00258084e-02</span><span class="p">,</span> <span class="mf">2.01461259e-02</span><span class="p">,</span>
             <span class="mf">1.84865110e-02</span><span class="p">,</span> <span class="mf">2.49667447e-02</span><span class="p">,</span> <span class="mf">2.73083989e-02</span><span class="p">,</span> <span class="mf">2.87465211e-02</span><span class="p">,</span>
             <span class="mf">2.89694592e-02</span><span class="p">,</span> <span class="mf">2.87686456e-02</span><span class="p">,</span> <span class="mf">2.87277419e-02</span><span class="p">,</span> <span class="mf">3.08121163e-02</span><span class="p">,</span>
             <span class="mf">3.22086290e-02</span><span class="p">,</span> <span class="mf">3.35262120e-02</span><span class="p">,</span> <span class="mf">3.41329686e-02</span><span class="p">,</span> <span class="mf">3.05218045e-02</span><span class="p">,</span>
             <span class="mf">3.30278911e-02</span><span class="p">,</span> <span class="mf">3.58164124e-02</span><span class="p">,</span> <span class="mf">3.93186994e-02</span><span class="p">,</span> <span class="mf">4.15412188e-02</span><span class="p">,</span>
             <span class="mf">1.60520077e-02</span><span class="p">,</span> <span class="mf">1.82803553e-02</span><span class="p">,</span> <span class="mf">2.00258084e-02</span><span class="p">,</span> <span class="mf">2.01461259e-02</span><span class="p">,</span>
             <span class="mf">1.84865110e-02</span><span class="p">,</span> <span class="mf">2.49667447e-02</span><span class="p">,</span> <span class="mf">2.73083989e-02</span><span class="p">,</span> <span class="mf">2.87465211e-02</span><span class="p">,</span>
             <span class="mf">2.89694592e-02</span><span class="p">,</span> <span class="mf">2.87686456e-02</span><span class="p">,</span> <span class="mf">2.87277419e-02</span><span class="p">,</span> <span class="mf">3.08121163e-02</span><span class="p">,</span>
             <span class="mf">3.22086290e-02</span><span class="p">,</span> <span class="mf">3.35262120e-02</span><span class="p">,</span> <span class="mf">3.41329686e-02</span><span class="p">,</span> <span class="mf">3.05218045e-02</span><span class="p">,</span>
             <span class="mf">3.30278911e-02</span><span class="p">,</span> <span class="mf">3.58164124e-02</span><span class="p">,</span> <span class="mf">3.93186994e-02</span><span class="p">,</span> <span class="mf">4.15412188e-02</span><span class="p">])</span>\
            <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ALD2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">slided_reduced_bpchfile</span> <span class="o">=</span> <span class="n">slice_dim</span><span class="p">(</span>
            <span class="n">reduce_dim</span><span class="p">(</span><span class="n">bpchfile</span><span class="p">,</span> <span class="s1">&#39;layer,mean&#39;</span><span class="p">),</span> <span class="s1">&#39;time,0&#39;</span><span class="p">)</span>
        <span class="n">pncgen</span><span class="p">(</span><span class="n">slided_reduced_bpchfile</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">inmode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
               <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;bpch&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ALD2_check_slided_reduced</span> <span class="o">=</span> <span class="n">ALD2_check</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">ALD2</span> <span class="o">=</span> <span class="n">slided_reduced_bpchfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;IJ-AVG-$_ALD2&#39;</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">ALD2</span><span class="p">,</span> <span class="n">ALD2_check_slided_reduced</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;Not scaling variables; good for direct writing&#39;</span>
            <span class="p">)</span>
            <span class="n">bpchfile</span> <span class="o">=</span> <span class="n">bpch1</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
        <span class="n">ALD2</span> <span class="o">=</span> <span class="n">bpchfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;IJ-AVG-$_ALD2&#39;</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">ALD2</span><span class="p">,</span> <span class="n">ALD2_check_slided_reduced</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">testBPCH1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;Not scaling variables; good for direct writing&#39;</span>
            <span class="p">)</span>
            <span class="n">bpchfile</span> <span class="o">=</span> <span class="n">bpch1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bpchpath</span><span class="p">)</span>
        <span class="n">ALD2</span> <span class="o">=</span> <span class="n">bpchfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;IJ-AVG-$_ALD2&#39;</span><span class="p">]</span>
        <span class="n">ALD2g</span> <span class="o">=</span> <span class="n">bpchfile</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;IJ-AVG-$&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;ALD2&#39;</span><span class="p">]</span>
        <span class="n">ALD2_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mf">1.60520077e-02</span><span class="p">,</span> <span class="mf">1.82803553e-02</span><span class="p">,</span> <span class="mf">2.00258084e-02</span><span class="p">,</span> <span class="mf">2.01461259e-02</span><span class="p">,</span>
             <span class="mf">1.84865110e-02</span><span class="p">,</span> <span class="mf">2.49667447e-02</span><span class="p">,</span> <span class="mf">2.73083989e-02</span><span class="p">,</span> <span class="mf">2.87465211e-02</span><span class="p">,</span>
             <span class="mf">2.89694592e-02</span><span class="p">,</span> <span class="mf">2.87686456e-02</span><span class="p">,</span> <span class="mf">2.87277419e-02</span><span class="p">,</span> <span class="mf">3.08121163e-02</span><span class="p">,</span>
             <span class="mf">3.22086290e-02</span><span class="p">,</span> <span class="mf">3.35262120e-02</span><span class="p">,</span> <span class="mf">3.41329686e-02</span><span class="p">,</span> <span class="mf">3.05218045e-02</span><span class="p">,</span>
             <span class="mf">3.30278911e-02</span><span class="p">,</span> <span class="mf">3.58164124e-02</span><span class="p">,</span> <span class="mf">3.93186994e-02</span><span class="p">,</span> <span class="mf">4.15412188e-02</span><span class="p">,</span>
             <span class="mf">1.60520077e-02</span><span class="p">,</span> <span class="mf">1.82803553e-02</span><span class="p">,</span> <span class="mf">2.00258084e-02</span><span class="p">,</span> <span class="mf">2.01461259e-02</span><span class="p">,</span>
             <span class="mf">1.84865110e-02</span><span class="p">,</span> <span class="mf">2.49667447e-02</span><span class="p">,</span> <span class="mf">2.73083989e-02</span><span class="p">,</span> <span class="mf">2.87465211e-02</span><span class="p">,</span>
             <span class="mf">2.89694592e-02</span><span class="p">,</span> <span class="mf">2.87686456e-02</span><span class="p">,</span> <span class="mf">2.87277419e-02</span><span class="p">,</span> <span class="mf">3.08121163e-02</span><span class="p">,</span>
             <span class="mf">3.22086290e-02</span><span class="p">,</span> <span class="mf">3.35262120e-02</span><span class="p">,</span> <span class="mf">3.41329686e-02</span><span class="p">,</span> <span class="mf">3.05218045e-02</span><span class="p">,</span>
             <span class="mf">3.30278911e-02</span><span class="p">,</span> <span class="mf">3.58164124e-02</span><span class="p">,</span> <span class="mf">3.93186994e-02</span><span class="p">,</span> <span class="mf">4.15412188e-02</span><span class="p">,</span>
             <span class="mf">1.60520077e-02</span><span class="p">,</span> <span class="mf">1.82803553e-02</span><span class="p">,</span> <span class="mf">2.00258084e-02</span><span class="p">,</span> <span class="mf">2.01461259e-02</span><span class="p">,</span>
             <span class="mf">1.84865110e-02</span><span class="p">,</span> <span class="mf">2.49667447e-02</span><span class="p">,</span> <span class="mf">2.73083989e-02</span><span class="p">,</span> <span class="mf">2.87465211e-02</span><span class="p">,</span>
             <span class="mf">2.89694592e-02</span><span class="p">,</span> <span class="mf">2.87686456e-02</span><span class="p">,</span> <span class="mf">2.87277419e-02</span><span class="p">,</span> <span class="mf">3.08121163e-02</span><span class="p">,</span>
             <span class="mf">3.22086290e-02</span><span class="p">,</span> <span class="mf">3.35262120e-02</span><span class="p">,</span> <span class="mf">3.41329686e-02</span><span class="p">,</span> <span class="mf">3.05218045e-02</span><span class="p">,</span>
             <span class="mf">3.30278911e-02</span><span class="p">,</span> <span class="mf">3.58164124e-02</span><span class="p">,</span> <span class="mf">3.93186994e-02</span><span class="p">,</span> <span class="mf">4.15412188e-02</span><span class="p">])</span>\
            <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ALD2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">ALD2</span><span class="p">,</span> <span class="n">ALD2_check</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">ALD2g</span><span class="p">,</span> <span class="n">ALD2_check</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">bpchfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;hyai&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.04804826</span><span class="p">,</span> <span class="mf">6.593752</span><span class="p">,</span> <span class="mf">13.1348</span><span class="p">,</span> <span class="mf">19.61311</span><span class="p">,</span> <span class="mf">26.09201</span><span class="p">,</span> <span class="mf">32.57081</span><span class="p">,</span>
             <span class="mf">38.98201</span><span class="p">,</span> <span class="mf">45.33901</span><span class="p">,</span> <span class="mf">51.69611</span><span class="p">,</span> <span class="mf">58.05321</span><span class="p">,</span> <span class="mf">64.36264</span><span class="p">,</span> <span class="mf">70.62198</span><span class="p">,</span>
             <span class="mf">78.83422</span><span class="p">,</span> <span class="mf">89.09992</span><span class="p">,</span> <span class="mf">99.36521</span><span class="p">,</span> <span class="mf">109.1817</span><span class="p">,</span> <span class="mf">118.9586</span><span class="p">,</span> <span class="mf">128.6959</span><span class="p">,</span>
             <span class="mf">142.91</span><span class="p">,</span> <span class="mf">156.26</span><span class="p">,</span> <span class="mf">169.609</span><span class="p">,</span> <span class="mf">181.619</span><span class="p">,</span> <span class="mf">193.097</span><span class="p">,</span> <span class="mf">203.259</span><span class="p">,</span> <span class="mf">212.15</span><span class="p">,</span>
             <span class="mf">218.776</span><span class="p">,</span> <span class="mf">223.898</span><span class="p">,</span> <span class="mf">224.363</span><span class="p">,</span> <span class="mf">216.865</span><span class="p">,</span> <span class="mf">201.192</span><span class="p">,</span> <span class="mf">176.93</span><span class="p">,</span> <span class="mf">150.393</span><span class="p">,</span>
             <span class="mf">127.837</span><span class="p">,</span> <span class="mf">108.663</span><span class="p">,</span> <span class="mf">92.36572</span><span class="p">,</span> <span class="mf">78.51231</span><span class="p">,</span> <span class="mf">56.38791</span><span class="p">,</span> <span class="mf">40.17541</span><span class="p">,</span>
             <span class="mf">28.36781</span><span class="p">,</span> <span class="mf">19.7916</span><span class="p">,</span> <span class="mf">9.292942</span><span class="p">,</span> <span class="mf">4.076571</span><span class="p">,</span> <span class="mf">1.65079</span><span class="p">,</span> <span class="mf">0.6167791</span><span class="p">,</span>
             <span class="mf">0.211349</span><span class="p">,</span> <span class="mf">0.06600001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span> <span class="s1">&#39;f&#39;</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">bpchfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;hybi&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.984952</span><span class="p">,</span> <span class="mf">0.963406</span><span class="p">,</span> <span class="mf">0.941865</span><span class="p">,</span> <span class="mf">0.920387</span><span class="p">,</span> <span class="mf">0.898908</span><span class="p">,</span> <span class="mf">0.877429</span><span class="p">,</span>
             <span class="mf">0.856018</span><span class="p">,</span> <span class="mf">0.8346609</span><span class="p">,</span> <span class="mf">0.8133039</span><span class="p">,</span> <span class="mf">0.7919469</span><span class="p">,</span> <span class="mf">0.7706375</span><span class="p">,</span> <span class="mf">0.7493782</span><span class="p">,</span>
             <span class="mf">0.721166</span><span class="p">,</span> <span class="mf">0.6858999</span><span class="p">,</span> <span class="mf">0.6506349</span><span class="p">,</span> <span class="mf">0.6158184</span><span class="p">,</span> <span class="mf">0.5810415</span><span class="p">,</span> <span class="mf">0.5463042</span><span class="p">,</span>
             <span class="mf">0.4945902</span><span class="p">,</span> <span class="mf">0.4437402</span><span class="p">,</span> <span class="mf">0.3928911</span><span class="p">,</span> <span class="mf">0.3433811</span><span class="p">,</span> <span class="mf">0.2944031</span><span class="p">,</span> <span class="mf">0.2467411</span><span class="p">,</span>
             <span class="mf">0.2003501</span><span class="p">,</span> <span class="mf">0.1562241</span><span class="p">,</span> <span class="mf">0.1136021</span><span class="p">,</span> <span class="mf">0.06372006</span><span class="p">,</span> <span class="mf">0.02801004</span><span class="p">,</span>
             <span class="mf">0.006960025</span><span class="p">,</span> <span class="mf">8.175413e-09</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
             <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="s1">&#39;f&#39;</span><span class="p">))</span>
        <span class="n">etai_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mf">1.01325000e+03</span><span class="p">,</span> <span class="mf">9.98050662e+02</span><span class="p">,</span> <span class="mf">9.82764882e+02</span><span class="p">,</span> <span class="mf">9.67479511e+02</span><span class="p">,</span>
             <span class="mf">9.52195238e+02</span><span class="p">,</span> <span class="mf">9.36910541e+02</span><span class="p">,</span> <span class="mf">9.21625744e+02</span><span class="p">,</span> <span class="mf">9.06342248e+02</span><span class="p">,</span>
             <span class="mf">8.91059167e+02</span><span class="p">,</span> <span class="mf">8.75776287e+02</span><span class="p">,</span> <span class="mf">8.60493406e+02</span><span class="p">,</span> <span class="mf">8.45211087e+02</span><span class="p">,</span>
             <span class="mf">8.29929441e+02</span><span class="p">,</span> <span class="mf">8.09555669e+02</span><span class="p">,</span> <span class="mf">7.84087994e+02</span><span class="p">,</span> <span class="mf">7.58621022e+02</span><span class="p">,</span>
             <span class="mf">7.33159694e+02</span><span class="p">,</span> <span class="mf">7.07698900e+02</span><span class="p">,</span> <span class="mf">6.82238631e+02</span><span class="p">,</span> <span class="mf">6.44053520e+02</span><span class="p">,</span>
             <span class="mf">6.05879758e+02</span><span class="p">,</span> <span class="mf">5.67705907e+02</span><span class="p">,</span> <span class="mf">5.29549900e+02</span><span class="p">,</span> <span class="mf">4.91400941e+02</span><span class="p">,</span>
             <span class="mf">4.53269420e+02</span><span class="p">,</span> <span class="mf">4.15154739e+02</span><span class="p">,</span> <span class="mf">3.77070069e+02</span><span class="p">,</span> <span class="mf">3.39005328e+02</span><span class="p">,</span>
             <span class="mf">2.88927351e+02</span><span class="p">,</span> <span class="mf">2.45246173e+02</span><span class="p">,</span> <span class="mf">2.08244245e+02</span><span class="p">,</span> <span class="mf">1.76930008e+02</span><span class="p">,</span>
             <span class="mf">1.50393000e+02</span><span class="p">,</span> <span class="mf">1.27837000e+02</span><span class="p">,</span> <span class="mf">1.08663000e+02</span><span class="p">,</span> <span class="mf">9.23657200e+01</span><span class="p">,</span>
             <span class="mf">7.85123100e+01</span><span class="p">,</span> <span class="mf">5.63879100e+01</span><span class="p">,</span> <span class="mf">4.01754100e+01</span><span class="p">,</span> <span class="mf">2.83678100e+01</span><span class="p">,</span>
             <span class="mf">1.97916000e+01</span><span class="p">,</span> <span class="mf">9.29294200e+00</span><span class="p">,</span> <span class="mf">4.07657100e+00</span><span class="p">,</span> <span class="mf">1.65079000e+00</span><span class="p">,</span>
             <span class="mf">6.16779100e-01</span><span class="p">,</span> <span class="mf">2.11349000e-01</span><span class="p">,</span> <span class="mf">6.60000100e-02</span><span class="p">,</span> <span class="mf">1.00000000e-02</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">bpchfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;etai_pressure&#39;</span><span class="p">],</span>
                                   <span class="n">etai_check</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">runTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Barron H. Henderson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>